<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–Ω–∞–∂–µ—Ä –æ—Ç –®–∞–º–∏–ª—è –∏ –ü—É—à–∫–∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            overflow: hidden;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: flex;
        }
        .bubble {
            background-color: white;
            border: 3px solid #3b82f6;
            padding: 1rem;
            border-radius: 1.5rem;
            position: relative;
        }
        .bubble::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 20%;
            width: 0;
            height: 0;
            border: 20px solid transparent;
            border-top-color: #3b82f6;
            border-bottom: 0;
            margin-left: -20px;
            margin-bottom: -20px;
        }
        .path-canvas {
            cursor: crosshair;
        }
        .butterfly-wrapper {
            position: absolute;
            width: 64px;
            height: 64px;
            cursor: pointer;
            transition: transform 0.3s linear;
        }
        .chest {
            transition: transform 0.2s ease;
        }
        .chest.opened {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-blue-100 min-h-screen flex items-center justify-center p-4">

    <!-- –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
    <div id="app-container" class="w-full max-w-4xl h-[90vh] max-h-[700px] bg-white rounded-2xl shadow-2xl flex flex-col p-6 relative overflow-hidden">

        <!-- –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ -->
        <div class="absolute bottom-4 left-4 z-10 w-24 md:w-32">
            <!-- –ü—É—à–æ–∫ -->
            <svg id="pushok-char" viewBox="0 0 100 100" class="w-full h-full">
                <g>
                    <path d="M50 8c-14.8 0-26.8 12-26.8 26.8 0 8.7 4.2 16.4 10.7 21.2-1.3-1.2-2.1-3-2.1-5 0-4.1 3.4-7.5 7.5-7.5s7.5 3.4 7.5 7.5c0 2-.8 3.8-2.1 5 6.5-4.8 10.7-12.5 10.7-21.2C76.8 20 64.8 8 50 8z" fill="#E0E0E0"/>
                    <path d="M50 80c-16.6 0-30-13.4-30-30 0-4.4 1-8.6 2.7-12.4C27.9 44.5 38.1 50 50 50s22.1-5.5 27.3-12.4c1.8 3.8 2.7 8 2.7 12.4 0 16.6-13.4 30-30 30z" fill="#F5F5F5"/>
                    <circle cx="38" cy="32" r="4" fill="#212121"/>
                    <circle cx="62" cy="32" r="4" fill="#212121"/>
                    <path d="M46 40c1.1 0 2.1.9 2.1 2s-.9 2-2.1 2-2.1-.9-2.1-2 .9-2 2.1-2zm8 0c1.1 0 2.1.9 2.1 2s-.9 2-2.1 2-2.1-.9-2.1-2 .9-2 2.1-2z" fill="#FFC107"/>
                </g>
            </svg>
        </div>
       
        <!-- –û–±–ª–∞—Å—Ç—å —Ä–∞—Å—Å–∫–∞–∑–∞ –ü—É—à–∫–∞ -->
        <div id="story-panel" class="absolute bottom-40 right-4 bg-yellow-100 border-2 border-yellow-300 p-3 rounded-lg w-1/3 h-1/5 overflow-y-auto text-sm z-20">
            <h3 class="font-bold text-yellow-800">–†–∞—Å—Å–∫–∞–∑ –ü—É—à–∫–∞:</h3>
            <div id="story-content" class="mt-1 text-gray-700"></div>
        </div>

        <!-- ---------------- –≠–ö–†–ê–ù–´ ---------------- -->

        <!-- –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω -->
        <div id="start-screen" class="screen active flex-col items-center justify-center text-center gap-6">
            <h1 class="text-4xl md:text-6xl font-bold text-blue-600">–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–π —Ç—Ä–µ–Ω–∞–∂–µ—Ä</h1>
            <p class="text-lg md:text-2xl text-gray-700">–ü—Ä–∏–≤–µ—Ç! –ü–æ–º–æ–≥–∏ –ü—É—à–∫—É –¥–æ–ø–∏—Å–∞—Ç—å –µ–≥–æ —Ä–∞—Å—Å–∫–∞–∑, –æ—Å–≤–æ–∏–≤ –º—ã—à–∫—É –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É!</p>
            <button onclick="showScreen('main-menu')" class="mt-8 px-10 py-5 bg-green-500 text-white text-2xl font-bold rounded-full shadow-lg hover:bg-green-600 transform hover:scale-105 transition-transform">–ù–∞—á–∞—Ç—å!</button>
        </div>
        
        <!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
        <div id="main-menu" class="screen flex-col items-center justify-center text-center gap-8">
            <h2 class="text-3xl md:text-5xl font-bold text-blue-600">–í—ã–±–µ—Ä–∏, —Å —á–µ–≥–æ –Ω–∞—á–Ω–µ–º?</h2>
            <div class="flex flex-col md:flex-row gap-8">
                <button onclick="showScreen('mouse-trainer-menu')" class="px-8 py-12 bg-yellow-400 text-white text-2xl font-bold rounded-2xl shadow-lg hover:bg-yellow-500 transform hover:scale-105 transition-transform">
                    <span class="text-5xl">üñ±Ô∏è</span><br>–ú—ã—à–∫–∞
                </button>
                <button onclick="showScreen('keyboard-trainer-menu')" class="px-8 py-12 bg-purple-400 text-white text-2xl font-bold rounded-2xl shadow-lg hover:bg-purple-500 transform hover:scale-105 transition-transform">
                    <span class="text-5xl">‚å®Ô∏è</span><br>–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞
                </button>
            </div>
        </div>

        <!-- –ú–µ–Ω—é —Ç—Ä–µ–Ω–∞–∂–µ—Ä–æ–≤ –º—ã—à–∏ -->
        <div id="mouse-trainer-menu" class="screen flex-col items-center justify-center text-center gap-4">
            <h2 class="text-3xl md:text-4xl font-bold text-yellow-600 mb-6">–¢—Ä–µ–Ω–∏—Ä—É–µ–º –ú—ã—à–∫—É</h2>
            <div class="flex flex-col gap-4 w-full max-w-xs">
                <button onclick="startButterflyGame()" class="px-6 py-4 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600">–ü–æ–π–º–∞–π –±–∞–±–æ—á–∫—É (–ö–ª–∏–∫)</button>
                <button onclick="startChestsGame()" class="px-6 py-4 bg-red-500 text-white rounded-lg shadow-md hover:bg-red-600">–û—Ç–∫—Ä–æ–π —Å—É–Ω–¥—É—á–∫–∏ (–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫)</button>
                <button onclick="startPathGame()" class="px-6 py-4 bg-indigo-500 text-white rounded-lg shadow-md hover:bg-indigo-600">–í–µ–¥–∏ –ø–æ –¥–æ—Ä–æ–∂–∫–µ (–¢–æ—á–Ω–æ—Å—Ç—å)</button>
            </div>
            <button onclick="showScreen('main-menu')" class="mt-8 px-6 py-3 bg-gray-400 text-white rounded-full hover:bg-gray-500">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
        </div>
        
        <!-- –ú–µ–Ω—é —Ç—Ä–µ–Ω–∞–∂–µ—Ä–æ–≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã -->
        <div id="keyboard-trainer-menu" class="screen flex-col items-center justify-center text-center gap-4">
            <h2 class="text-3xl md:text-4xl font-bold text-purple-600 mb-6">–¢—Ä–µ–Ω–∏—Ä—É–µ–º –ö–ª–∞–≤–∏–∞—Ç—É—Ä—É</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <button onclick="showScreen('type-name-screen')" class="px-6 py-4 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600">–ù–∞–ø–µ—á–∞—Ç–∞–π —Å–≤–æ–µ –∏–º—è</button>
                 <button onclick="showScreen('space-enter-screen')" class="px-6 py-4 bg-green-500 text-white rounded-lg shadow-md hover:bg-green-600">–¢—Ä–µ–Ω–∞–∂–µ—Ä "–ü—Ä–æ–±–µ–ª"</button>
            </div>
            <button onclick="showScreen('main-menu')" class="mt-8 px-6 py-3 bg-gray-400 text-white rounded-full hover:bg-gray-500">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
        </div>

        <!-- –≠–∫—Ä–∞–Ω: –ò–≥—Ä–∞ "–ü–æ–π–º–∞–π –±–∞–±–æ—á–∫—É" -->
        <div id="butterfly-game-screen" class="screen flex-col items-center justify-center text-center gap-4 relative w-full h-full">
            <div class="absolute top-2 left-2 text-xl font-bold z-10">–ü–æ–π–º–∞–Ω–æ: <span id="butterfly-score">0</span> / 5</div>
            <div class="absolute top-2 right-2 text-xl font-bold z-10">–í—Ä–µ–º—è: <span id="butterfly-timer">15</span></div>
            <div id="butterfly-area" class="w-full h-full bg-sky-200 rounded-lg relative overflow-hidden cursor-pointer">
                <!-- –ë–∞–±–æ—á–∫–∞ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –∑–¥–µ—Å—å —á–µ—Ä–µ–∑ JS -->
            </div>
            <button onclick="showScreen('mouse-trainer-menu')" class="absolute bottom-2 z-10 px-6 py-3 bg-gray-400 text-white rounded-full hover:bg-gray-500">–ó–∞–∫–æ–Ω—á–∏—Ç—å</button>
        </div>

        <!-- –≠–∫—Ä–∞–Ω: –ò–≥—Ä–∞ "–û—Ç–∫—Ä–æ–π —Å—É–Ω–¥—É—á–∫–∏" -->
        <div id="chests-game-screen" class="screen flex-col items-center justify-center text-center gap-4">
            <h2 class="text-2xl md:text-3xl font-bold text-red-600">–î–≤–∞–∂–¥—ã –∫–ª–∏–∫–Ω–∏, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –≤—Å–µ —Å—É–Ω–¥—É–∫–∏!</h2>
            <p>–û—Ç–∫—Ä—ã—Ç–æ: <span id="chests-opened">0</span> / 4</p>
            <div id="chests-area" class="grid grid-cols-2 gap-8 mt-4">
                <!-- –°—É–Ω–¥—É–∫–∏ –±—É–¥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
            </div>
            <button onclick="showScreen('mouse-trainer-menu')" class="mt-6 px-6 py-3 bg-gray-400 text-white rounded-full hover:bg-gray-500">–ù–∞–∑–∞–¥</button>
        </div>

        <!-- –≠–∫—Ä–∞–Ω: –ò–≥—Ä–∞ "–í–µ–¥–∏ –ø–æ –¥–æ—Ä–æ–∂–∫–µ" -->
        <div id="path-game-screen" class="screen flex-col items-center justify-center text-center gap-2">
            <h2 class="text-2xl font-bold text-indigo-600">–ó–∞–∂–º–∏ –º—ã—à–∫—É –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –∏ –≤–µ–¥–∏ –¥–æ —Ñ–∏–Ω–∏—à–∞!</h2>
            <canvas id="path-canvas" class="bg-green-100 rounded-lg shadow-inner path-canvas"></canvas>
            <button onclick="showScreen('mouse-trainer-menu')" class="mt-2 px-6 py-3 bg-gray-400 text-white rounded-full hover:bg-gray-500">–ù–∞–∑–∞–¥</button>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω: –ù–∞–ø–µ—á–∞—Ç–∞–π —Å–≤–æ–µ –∏–º—è -->
        <div id="type-name-screen" class="screen flex-col items-center justify-center text-center gap-4">
            <h2 class="text-2xl font-bold text-blue-600">–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç? –ù–∞–ø–∏—à–∏ –∑–¥–µ—Å—å:</h2>
            <input type="text" id="name-input" class="text-2xl p-3 border-2 border-gray-300 rounded-lg w-full max-w-sm text-center focus:border-blue-500 outline-none">
            <button id="submit-name-button" class="mt-4 px-8 py-3 bg-green-500 text-white rounded-full text-lg hover:bg-green-600">–ì–æ—Ç–æ–≤–æ!</button>
            <button onclick="showScreen('keyboard-trainer-menu')" class="mt-2 px-6 py-3 bg-gray-400 text-white rounded-full hover:bg-gray-500">–ù–∞–∑–∞–¥</button>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω: –ü—Ä–æ–±–µ–ª (–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π) -->
        <div id="space-enter-screen" class="screen flex-col items-center justify-center text-center gap-4 w-full">
            <h2 class="text-2xl font-bold text-green-600">–ü–æ—Å—Ç–∞–≤—å –ø—Ä–æ–±–µ–ª –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏</h2>
            <p class="text-gray-600">–ù–∞–∂–º–∏ –¥–ª–∏–Ω–Ω—É—é –∫–ª–∞–≤–∏—à—É <kbd class="px-2 py-1 text-xs font-semibold text-gray-800 bg-gray-100 border border-gray-200 rounded-lg">–ü—Ä–æ–±–µ–ª</kbd>.</p>
            <div id="space-enter-task" class="p-4 bg-gray-100 rounded-lg w-full max-w-lg text-2xl">–ö–æ—Ç—Å–ø–∏—Ç</div>
            <input type="text" id="space-enter-input" class="text-2xl p-3 border-2 border-gray-300 rounded-lg w-full max-w-sm text-center focus:border-green-500 outline-none" />
            <button id="space-enter-check" class="mt-4 px-8 py-3 bg-blue-500 text-white rounded-full text-lg hover:bg-blue-600">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
            <button onclick="showScreen('keyboard-trainer-menu')" class="mt-2 px-6 py-3 bg-gray-400 text-white rounded-full hover:bg-gray-500">–ù–∞–∑–∞–¥</button>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ñ–∏–¥–±—ç–∫–æ–º -->
        <div id="feedback-modal" class="absolute inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
            <div class="bg-white p-8 rounded-2xl shadow-xl text-center w-full max-w-sm flex flex-col items-center gap-4">
                <div id="feedback-char" class="w-24 h-24"></div>
                <h3 id="feedback-title" class="text-3xl font-bold"></h3>
                <p id="feedback-text" class="text-lg"></p>
                <button id="feedback-button" class="mt-4 px-8 py-3 bg-green-500 text-white rounded-full text-lg">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
            </div>
        </div>
    </div>

<script>
    const screens = document.querySelectorAll('.screen');
    const storyContent = document.getElementById('story-content');
    
    // --- –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
    let currentScreen = 'start-screen';
    const storyParts = [
        "–ñ–∏–ª-–±—ã–ª –∫–æ—Å–º–∏—á–µ—Å–∫–∏–π –∫–æ—Ç.",
        "–û–Ω –ª–µ—Ç–∞–ª –Ω–∞ —Ä–∞–∫–µ—Ç–µ –∏–∑ –ø–æ–¥—É—à–µ–∫.",
        "–û–¥–Ω–∞–∂–¥—ã –æ–Ω –≤—Å—Ç—Ä–µ—Ç–∏–ª –ª—É–Ω–Ω—É—é –º—ã—à—å.",
        "–û–Ω–∏ –≤–º–µ—Å—Ç–µ –ø–∏–ª–∏ –º–æ–ª–æ—á–Ω—ã–µ –∫–æ–∫—Ç–µ–π–ª–∏.",
        "–ò —Å–º–æ—Ç—Ä–µ–ª–∏ –Ω–∞ –∑–≤–µ–∑–¥—ã.",
        "–ö–æ–Ω–µ—Ü!"
    ];
    let progress = {
        completedTasks: [],
        storyProgress: 0
    };

    // --- –û–ó–í–£–ß–ö–ê –ò–ù–°–¢–†–£–ö–¶–ò–ô ---
    window.speechSynthesis.onvoiceschanged = () => {};

    function speak(text) {
        if (!text || typeof window.speechSynthesis === 'undefined') return;
        const synth = window.speechSynthesis;
        if (synth.speaking) {
            synth.cancel();
        }
        
        setTimeout(() => {
            const utterThis = new SpeechSynthesisUtterance(text);
            const russianVoice = synth.getVoices().find(voice => voice.lang === 'ru-RU');
            if (russianVoice) {
                utterThis.voice = russianVoice;
            }
            utterThis.lang = 'ru-RU';
            utterThis.rate = 0.95; // Slightly faster for natural flow
            utterThis.pitch = 1.1; // Slightly higher pitch for friendliness
            synth.speak(utterThis);
        }, 100);
    }
    
    // –£–ª—É—á—à–µ–Ω–Ω—ã–µ –∏ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
    const instructions = {
        'butterfly-game-screen': '–ü–æ–π–º–∞–π –ø—è—Ç—å –±–∞–±–æ—á–µ–∫! –£ —Ç–µ–±—è 15 —Å–µ–∫—É–Ω–¥. –ö–ª–∏–∫–∞–π –ø–æ –Ω–∏–º –º—ã—à–∫–æ–π!',
        'chests-game-screen': '–°–∫–æ—Ä–µ–µ –æ—Ç–∫—Ä—ã–≤–∞–π —Å—É–Ω–¥—É–∫–ò! –ö–ª–∏–∫–Ω–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –¥–≤–∞ —Ä–∞–∑–∞, –±—ã—Å—Ç—Ä–æ-–±—ã—Å—Ç—Ä–æ.',
        'path-game-screen': '–ê–∫–∫—É—Ä–∞—Ç–Ω–æ –≤–µ–¥–∏ –º—ã—à–∫—É –ø–æ –¥–æ—Ä–æ–∂–∫–µ! –ó–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –∏ –Ω–µ –æ—Ç–ø—É—Å–∫–∞–π –¥–æ —Å–∞–º–æ–≥–æ —Ñ–∏–Ω–∏—à–∞.',
        'type-name-screen': '–ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç? –ù–∞–ø–µ—á–∞—Ç–∞–π —Å–≤–æ—ë –∏–º—è –∏ –Ω–∞–∂–º–∏ –∑–µ–ª—ë–Ω—É—é –∫–Ω–æ–ø–∫—É.',
        'space-enter-screen': '–°–¥–µ–ª–∞–π –ø—Ä–∞–≤–∏–ª—å–Ω–æ: –ö–æ—Ç —Å–ø–∏—Ç. –ü–æ—Å—Ç–∞–≤—å –ø—Ä–æ–±–µ–ª –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏.'
    };
    
    // --- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–∞–º–∏ ---
    function showScreen(screenId) {
        if (currentScreen === 'butterfly-game-screen') {
            endButterflyGame(false, true); 
        }
        const synth = window.speechSynthesis;
        if (synth.speaking) {
            synth.cancel();
        }

        screens.forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(screenId).classList.add('active');
        currentScreen = screenId;
        
        if (instructions[screenId]) {
            speak(instructions[screenId]);
        }
    }
    
    // --- –ê—É–¥–∏–æ-—Ñ–∏–¥–±—ç–∫ ---
    let audioCtx;
    function playSound(type = 'success') {
        if (!audioCtx) {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            } catch(e) {
                console.error("Web Audio API is not supported in this browser");
                return;
            }
        }
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        if (type === 'success') {
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(523.25, audioCtx.currentTime); // C5
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.5);
        } else if (type === 'click') {
            oscillator.type = 'triangle';
            oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.2);
        } else { // error
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(150, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + 0.3);
        }
        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.5);
    }
    
    // --- –°–∏—Å—Ç–µ–º–∞ –º–æ—Ç–∏–≤–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ ---
    function showFeedback(taskName, isSuccess) {
        const modal = document.getElementById('feedback-modal');
        const title = document.getElementById('feedback-title');
        const text = document.getElementById('feedback-text');
        const char = document.getElementById('feedback-char');
        const button = document.getElementById('feedback-button');
        const pushokNode = document.getElementById('pushok-char');

        char.innerHTML = ''; 
        
        if (isSuccess) {
            title.textContent = '–û—Ç–ª–∏—á–Ω–æ!';
            title.className = 'text-3xl font-bold text-green-500';
            if (pushokNode) char.appendChild(pushokNode.cloneNode(true));
            
            if (!progress.completedTasks.includes(taskName)) {
                progress.completedTasks.push(taskName);
                if (progress.storyProgress < storyParts.length) {
                    text.textContent = `–¢—ã –ø–æ–º–æ–≥ –ü—É—à–∫—É! –û–Ω –¥–æ–±–∞–≤–∏–ª –≤ —Ä–∞—Å—Å–∫–∞–∑: "${storyParts[progress.storyProgress]}"`;
                    progress.storyProgress++;
                } else {
                     text.textContent = "–£—Ä–∞! –†–∞—Å—Å–∫–∞–∑ –∑–∞–∫–æ–Ω—á–µ–Ω! –ù–æ —Ç—ã –º–æ–∂–µ—à—å —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è –¥–∞–ª—å—à–µ.";
                }
                saveProgress();
                updateStory();
            } else {
                text.textContent = "–¢—ã —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–ª —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ, –Ω–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ - –º–∞—Ç—å —É—á–µ–Ω–∏—è!";
            }
            playSound('success');
        } else {
            title.textContent = '–û–π, –æ—à–∏–±–∫–∞!';
            title.className = 'text-3xl font-bold text-red-500';
            text.textContent = '–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑, —É —Ç–µ–±—è –≤—Å–µ –ø–æ–ª—É—á–∏—Ç—Å—è!';
            playSound('error');
        }
        
        modal.style.display = 'flex';
        
        button.onclick = () => {
            modal.style.display = 'none';
        };
    }

    function showGameAlert(message, type = 'info') {
        const modal = document.getElementById('feedback-modal');
        const title = document.getElementById('feedback-title');
        const text = document.getElementById('feedback-text');
        const char = document.getElementById('feedback-char');
        const button = document.getElementById('feedback-button');
        const pushokNode = document.getElementById('pushok-char');
        
        char.innerHTML = ''; 

        if (type === 'success') {
            title.textContent = '–¢—Ä–µ–Ω–∞–∂–µ—Ä –ø—Ä–æ–π–¥–µ–Ω!';
            title.className = 'text-3xl font-bold text-green-500';
            if (pushokNode) char.appendChild(pushokNode.cloneNode(true));
        } else {
             title.textContent = '–í–Ω–∏–º–∞–Ω–∏–µ!';
             title.className = 'text-3xl font-bold text-blue-500';
        }

        text.textContent = message;
        
        modal.style.display = 'flex';
        
        button.onclick = () => {
            modal.style.display = 'none';
        };
    }

    function updateStory() {
        storyContent.innerHTML = '';
        for(let i=0; i < progress.storyProgress; i++) {
            const p = document.createElement('p');
            p.textContent = storyParts[i];
            storyContent.appendChild(p);
        }
    }
    
    function saveProgress() {
        localStorage.setItem('pushokTrainerProgress', JSON.stringify(progress));
    }
    
    function loadProgress() {
        const saved = localStorage.getItem('pushokTrainerProgress');
        if (saved) {
            progress = JSON.parse(saved);
        }
        updateStory();
    }

    // --- 1. –ò–≥—Ä–∞ "–ü–æ–π–º–∞–π –±–∞–±–æ—á–∫—É" ---
    let butterflyTimerInterval;
    let butterflyAnimationId;
    const butterflyArea = document.getElementById('butterfly-area');
    const butterflyScoreEl = document.getElementById('butterfly-score');
    const butterflyTimerEl = document.getElementById('butterfly-timer');
    const BUTTERFLY_SVG = `<svg viewBox="0 0 100 100" class="w-full h-full"><path d="M25,50 C-10,10 50,0 50,20 C50,0 110,10 75,50 L25,50 Z" fill="#FFC107"/><path d="M25,50 C-10,90 50,100 50,80 C50,100 110,90 75,50 L25,50 Z" fill="#FF9800"/></svg>`;
    let butterfly = null;
    let score = 0;

    function startButterflyGame() {
        showScreen('butterfly-game-screen');
        score = 0;
        let timeLeft = 15;
        butterflyScoreEl.textContent = score;
        butterflyTimerEl.textContent = timeLeft;
        butterflyArea.innerHTML = '';

        spawnButterfly();

        clearInterval(butterflyTimerInterval);
        butterflyTimerInterval = setInterval(() => {
            timeLeft--;
            butterflyTimerEl.textContent = timeLeft;
            if (timeLeft <= 0) {
                endButterflyGame(score >= 5);
            }
        }, 1000);
    }

    function spawnButterfly() {
        if (butterfly) butterfly.remove();

        butterfly = document.createElement('div');
        butterfly.className = 'butterfly-wrapper';
        butterfly.innerHTML = BUTTERFLY_SVG;
        
        const state = {
            x: Math.random() * (butterflyArea.clientWidth - 64),
            y: Math.random() * (butterflyArea.clientHeight - 64),
            targetX: Math.random() * (butterflyArea.clientWidth - 64),
            targetY: Math.random() * (butterflyArea.clientHeight - 64),
            speed: 2 + Math.random() * 2
        };

        butterfly.style.transform = `translate(${state.x}px, ${state.y}px)`;
        butterflyArea.appendChild(butterfly);

        function move() {
            const dx = state.targetX - state.x;
            const dy = state.targetY - state.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            if (distance < state.speed) {
                state.targetX = Math.random() * (butterflyArea.clientWidth - 64);
                state.targetY = Math.random() * (butterflyArea.clientHeight - 64);
            } else {
                state.x += (dx / distance) * state.speed;
                state.y += (dy / distance) * state.speed;
                butterfly.style.transform = `translate(${state.x}px, ${state.y}px)`;
            }
            butterflyAnimationId = requestAnimationFrame(move);
        }
        
        move();
        
        butterfly.onclick = (e) => {
            e.stopPropagation();
            score++;
            butterflyScoreEl.textContent = score;
            playSound('click');
            cancelAnimationFrame(butterflyAnimationId);
            butterfly.remove();
            if (score >= 5) {
                endButterflyGame(true);
            } else {
                setTimeout(spawnButterfly, 300);
            }
        };
    }

    function endButterflyGame(success, manual = false) {
        clearInterval(butterflyTimerInterval);
        if(butterflyAnimationId) cancelAnimationFrame(butterflyAnimationId);
        if (butterfly) {
            butterfly.remove();
            butterfly = null;
        }
        if (!manual) {
            showFeedback('butterfly', success);
            showScreen('mouse-trainer-menu');
        }
    }
    
    // --- 2. –ò–≥—Ä–∞ "–û—Ç–∫—Ä–æ–π —Å—É–Ω–¥—É—á–∫–∏" ---
    const chestsArea = document.getElementById('chests-area');
    const chestsOpenedEl = document.getElementById('chests-opened');
    const CHEST_CLOSED_SVG = `<svg viewBox="0 0 100 100" class="w-24 h-24 cursor-pointer"><rect x="10" y="30" width="80" height="60" rx="5" fill="#A1662F"/><rect x="5" y="20" width="90" height="20" rx="5" fill="#D4AC0D"/><rect x="45" y="50" width="10" height="15" fill="#2C3E50"/></svg>`;
    const CHEST_OPENED_SVG = `<svg viewBox="0 0 100 100" class="w-24 h-24"><rect x="10" y="30" width="80" height="60" rx="5" fill="#A1662F"/><path d="M5 25 L 30 5 L 70 5 L 95 25 Z" fill="#D4AC0D"/><circle cx="50" cy="50" r="10" fill="gold"/><circle cx="40" cy="60" r="5" fill="red"/><circle cx="60" cy="60" r="5" fill="blue"/></svg>`;

    function startChestsGame() {
        showScreen('chests-game-screen');
        chestsArea.innerHTML = '';
        let openedCount = 0;
        chestsOpenedEl.textContent = openedCount;
        
        for (let i = 0; i < 4; i++) {
            const chest = document.createElement('div');
            chest.className = 'chest';
            chest.innerHTML = CHEST_CLOSED_SVG;
            chest.dataset.opened = "false";
            
            chest.ondblclick = () => {
                if (chest.dataset.opened === "false") {
                    chest.innerHTML = CHEST_OPENED_SVG;
                    chest.classList.add('opened');
                    chest.dataset.opened = "true";
                    openedCount++;
                    chestsOpenedEl.textContent = openedCount;
                    playSound('success');
                    if (openedCount === 4) {
                       setTimeout(()=>showFeedback('chests', true), 300);
                    }
                }
            };
            chestsArea.appendChild(chest);
        }
    }
    
    // --- 3. –ò–≥—Ä–∞ "–í–µ–¥–∏ –ø–æ –¥–æ—Ä–æ–∂–∫–µ" ---
    const pathCanvas = document.getElementById('path-canvas');
    const pathCtx = pathCanvas.getContext('2d');
    let pathDrawing = false;
    let userPath = [];
    let offscreenPathCanvas = null;
    let offscreenPathCtx = null;

    function startPathGame() {
        showScreen('path-game-screen');
        const container = document.getElementById('app-container');
        setTimeout(() => {
            const canvasWidth = container.clientWidth * 0.8;
            const canvasHeight = container.clientHeight * 0.6;
            pathCanvas.width = canvasWidth;
            pathCanvas.height = canvasHeight;

            offscreenPathCanvas = document.createElement('canvas');
            offscreenPathCanvas.width = canvasWidth;
            offscreenPathCanvas.height = canvasHeight;
            offscreenPathCtx = offscreenPathCanvas.getContext('2d', { willReadFrequently: true });
            
            resetPathGame();
        }, 100);
    }
    
    function resetPathGame() {
        pathDrawing = false;
        userPath = [];
        drawPath();
    }

    function drawPath() {
        if (!offscreenPathCtx) return;
        const w = pathCanvas.width;
        const h = pathCanvas.height;
        
        pathCtx.clearRect(0, 0, w, h);
        offscreenPathCtx.clearRect(0, 0, w, h);

        const roadPath2D = new Path2D();
        roadPath2D.moveTo(30, h / 2);
        roadPath2D.bezierCurveTo(w * 0.25, 20, w * 0.75, h - 20, w - 30, h / 2);
        
        offscreenPathCtx.lineWidth = 60;
        offscreenPathCtx.strokeStyle = 'black'; 
        offscreenPathCtx.stroke(roadPath2D);
        
        pathCtx.lineWidth = 60;
        pathCtx.strokeStyle = '#fde68a';
        pathCtx.lineCap = 'round';
        pathCtx.stroke(roadPath2D);
        
        if (userPath.length > 1) {
            pathCtx.beginPath();
            pathCtx.moveTo(userPath[0].x, userPath[0].y);
            for(let i=1; i<userPath.length; i++) {
                pathCtx.lineTo(userPath[i].x, userPath[i].y);
            }
            pathCtx.strokeStyle = '#3b82f6';
            pathCtx.lineWidth = 5;
            pathCtx.stroke();
        }

        pathCtx.fillStyle = '#4ade80';
        pathCtx.beginPath();
        pathCtx.arc(30, h / 2, 25, 0, 2 * Math.PI);
        pathCtx.fill();
        pathCtx.fillStyle = 'white';
        pathCtx.font = 'bold 14px Inter';
        pathCtx.textAlign = 'center';
        pathCtx.textBaseline = 'middle';
        pathCtx.fillText('–°—Ç–∞—Ä—Ç', 30, h / 2);

        pathCtx.fillStyle = '#f87171';
        pathCtx.beginPath();
        pathCtx.arc(w - 30, h / 2, 25, 0, 2 * Math.PI);
        pathCtx.fill();
        pathCtx.fillStyle = 'white';
        pathCtx.fillText('–§–∏–Ω–∏—à', w - 30, h / 2);
    }
    
    pathCanvas.addEventListener('mousedown', (e) => {
        const rect = pathCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        if (Math.hypot(x - 30, y - pathCanvas.height/2) < 25) {
            pathDrawing = true;
            userPath = [{x, y}];
            drawPath();
        }
    });

    pathCanvas.addEventListener('mouseup', (e) => {
        if (!pathDrawing) return;
        pathDrawing = false;
        
        const rect = pathCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        if (Math.hypot(x - (pathCanvas.width - 30), y - pathCanvas.height/2) < 25) {
            showGameAlert('–¢—Ä–µ–Ω–∞–∂–µ—Ä –ø—Ä–æ–π–¥–µ–Ω!', 'success');
            setTimeout(() => showFeedback('path', true), 1200);
        } else {
            showGameAlert('–ù—É–∂–Ω–æ –∑–∞–∫–æ–Ω—á–∏—Ç—å –Ω–∞ –∫—Ä—É–∂–∫–µ "–§–∏–Ω–∏—à"!');
            setTimeout(resetPathGame, 1500);
        }
    });
    
    pathCanvas.addEventListener('mouseleave', () => {
        if (pathDrawing) {
            pathDrawing = false;
            showGameAlert('–ú—ã—à–∫–∞ —É—à–ª–∞ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –ø–æ–ª—è. –ù–∞—á–Ω–µ–º –∑–∞–Ω–æ–≤–æ!');
            setTimeout(resetPathGame, 1500);
        }
    });

    pathCanvas.addEventListener('mousemove', (e) => {
        if (!pathDrawing || !offscreenPathCtx) return;

        const rect = pathCanvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        const pixelData = offscreenPathCtx.getImageData(x, y, 1, 1).data;
        if (pixelData[3] === 0) {
            playSound('error');
            pathDrawing = false;
            showGameAlert('–û–π, —Ç—ã —Å—ä–µ—Ö–∞–ª —Å –¥–æ—Ä–æ–∂–∫–∏! –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.');
            setTimeout(resetPathGame, 1500);
            return;
        }

        userPath.push({x, y});
        drawPath();
    });


    // --- 4. –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "–ù–∞–ø–µ—á–∞—Ç–∞–π –∏–º—è" ---
    const nameInput = document.getElementById('name-input');
    const submitNameBtn = document.getElementById('submit-name-button');
    submitNameBtn.onclick = () => {
        if (nameInput.value.trim().length > 1) {
            showFeedback('type-name', true);
            showGameAlert(`–ü—Ä–∏–≤–µ—Ç, ${nameInput.value}! –£ —Ç–µ–±—è –æ—Ç–ª–∏—á–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç—Å—è!`);
            nameInput.value = '';
        } else {
            showFeedback('type-name', false);
        }
    };
    
    // --- 5. –£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ "–ü—Ä–æ–±–µ–ª" ---
    const spaceEnterInput = document.getElementById('space-enter-input');
    const spaceEnterCheckBtn = document.getElementById('space-enter-check');
    const correctSpaceText = "–ö–æ—Ç —Å–ø–∏—Ç";
    spaceEnterCheckBtn.onclick = () => {
        const userText = spaceEnterInput.value.trim();
        if(userText === correctSpaceText) {
            showFeedback('space-enter', true);
            spaceEnterInput.value = '';
        } else {
            showFeedback('space-enter', false);
        }
    };
    

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    window.onload = () => {
        loadProgress();
    };

</script>

</body>
</html>




